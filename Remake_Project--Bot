import telebot
import random
import time
import logging
import requests
from collections import defaultdict

try:
    response = requests.get("https://api.telegram.org", timeout=10)
    print("API Telegram –¥–æ—Å—Ç—É–ø–µ–Ω")
except Exception as e:
    print(f"–ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º: {e}")

logging.basicConfig(level=logging.INFO)

# –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω –æ—Ç @BotFather
TOKEN = '7020085710:AAEI_4C5mrfH_sPsR7FvO2qAmTD3EqmGCRY'
bot = telebot.TeleBot(TOKEN)

# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–≥—Ä—ã
games = {}  # –°–ª–æ–≤–∞—Ä—å: chat_id -> {'players': [], 'roles': [], 'phase': 'waiting', 'votes': {}, 'shpions': []}

# –°–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ä–æ–ª–µ–π (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π)
professions = ['–í—Ä–∞—á,', '–ò–Ω–∂–µ–Ω–µ—Ä', '–£—á–∏—Ç–µ–ª—å,', '–ü–æ–≤–∞—Ä,', '–ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç,', '–§–µ—Ä–º–µ—Ä,', '–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç,', '–ú–µ—Ö–∞–Ω–∏–∫,', '–ü—Å–∏—Ö–æ–ª–æ–≥,', '–°—Ç—Ä–æ–∏—Ç–µ–ª—å,', '–•—É–¥–æ–∂–Ω–∏–∫,', '–í–æ–µ–Ω–Ω—ã–π', '–≠–∫–æ–Ω–æ–º–∏—Å—Ç,', '–§–∞—Ä–º–∞—Ü–µ–≤—Ç,', '–°–ø–æ—Ä—Ç—Å–º–µ–Ω']
p_y = ['15-–ª–µ—Ç–Ω–∏–º_—Å—Ç–∞–∂–µ–º,', '10-–ª–µ—Ç–Ω–∏–º_–æ–ø—ã—Ç–æ–º,', '8-–ª–µ—Ç–Ω–∏–º_—Å—Ç–∞–∂–µ–º,', '12-–ª–µ—Ç–Ω–∏–º_–æ–ø—ã—Ç–æ–º,', '0-–ª–µ—Ç–Ω–∏–º_—Å—Ç–∞–∂–µ–º,', '20-–ª–µ—Ç–Ω–∏–º_–æ–ø—ã—Ç–æ–º,', '1-–ª–µ—Ç–Ω–∏–º_—Å—Ç–∞–∂–µ–º,', '14-–ª–µ—Ç–Ω–∏–º_–æ–ø—ã—Ç–æ–º,', '9-–ª–µ—Ç–Ω–∏–º_—Å—Ç–∞–∂–µ–º,', '18-–ª–µ—Ç–Ω–∏–º_–æ–ø—ã—Ç–æ–º,', '6-–ª–µ—Ç–Ω–∏–º_—Å—Ç–∞–∂–µ–º,', '11-–ª–µ—Ç–Ω–∏–º_–æ–ø—ã—Ç–æ–º,', '13-–ª–µ—Ç–Ω–∏–º_—Å—Ç–∞–∂–µ–º,', '4-–ª–µ—Ç–Ω–∏–º_–æ–ø—ã—Ç–æ–º,', '16-–ª–µ—Ç–Ω–∏–º_—Å—Ç–∞–∂–µ–º']
people = ["–ú—É–∂—á–∏–Ω–∞", "–ñ–µ–Ω—â–∏–Ω–∞"]
rost = ['168—Å–º,', '182—Å–º,', '160—Å–º,', '178—Å–º,', '165—Å–º,', '172—Å–º,', '170—Å–º,', '185—Å–º,', '162—Å–º,', '168—Å–º,', '175—Å–º,', '180—Å–º,', '158—Å–º']
years = ['45–ª–µ—Ç,', '32–≥–æ–¥–∞,', '28–ª–µ—Ç,', '50–ª–µ—Ç,', '18–ª–µ—Ç,', '25–ª–µ—Ç,', '55–ª–µ—Ç,', '40–ª–µ—Ç,', '22–≥–æ–¥–∞,', '35–ª–µ—Ç,', '60–ª–µ—Ç,', '29–ª–µ—Ç,', '47–ª–µ—Ç,', '10–ª–µ—Ç,', '99–≥–æ–¥–∞']
healths = ['–ë–æ–ª–µ–Ω', '–ò–Ω–≤–∞–ª–∏–¥', '–ê—Å—Ç–º–∞—Ç–∏–∫,', '–î–∏–∞–±–µ—Ç–∏–∫,', '–ù–µ—Ç_—Ä—É–∫–∏,', '–°–ª–∞–±—ã–π_–∏–º–º—É–Ω–∏—Ç–µ—Ç,', '–ë–ª–∏–∑–æ—Ä—É–∫–æ—Å—Ç—å,', '–°–µ—Ä–¥–µ—á–Ω—ã–µ_–ø—Ä–æ–±–ª–µ–º—ã,', '–û–∂–∏—Ä–µ–Ω–∏–µ,', '–ó–¥–æ—Ä–æ–≤—å–µ_—Ö–æ—Ä–æ—à–µ–µ,', '–ü–µ—Ä–µ–ª–æ–º_–Ω–æ–≥–∏,', '–ê–ª–ª–µ—Ä–≥–∏—è_–Ω–∞_—Å–æ–±–∞–∫,', '–ü—Ä–æ–±–ª–µ–º—ã_—Å_—Å—É—Å—Ç–∞–≤–∞–º–∏']
hobbies = ['–ß—Ç–µ–Ω–∏–µ', '–°–ø–æ—Ä—Ç', '–ò–≥—Ä—ã', '–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ_–≤_–ª–µ—Å—É,', '–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞_–ø–ª–∞—Å—Ç–∏–∫–∞,', '–í—ã—Ä–∞—â–∏–≤–∞–Ω–∏–µ_–≥—Ä–∏–±–æ–≤,–†–µ–º–æ–Ω—Ç_–º–µ–ª–∫–æ–π_—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏,', '–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ,', '3D‚Äë–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ,', '–ò–≥—Ä–∞_–Ω–∞_–º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö_–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö,', '–†–∏—Å–æ–≤–∞–Ω–∏–µ,', '–°–æ—á–∏–Ω–µ–Ω–∏–µ_—Å—Ç–∏—Ö–æ–≤,', '–ü–ª–µ—Ç–µ–Ω–∏–µ_–∏–∑_–Ω–∏—Ç–æ–∫,', '–¢–µ–∞—Ç—Ä–∞–ª—å–Ω—ã–µ_–∏–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏–∏,', '–†–∞—Å—Å–∫–∞–∑—ã–≤–∞–Ω–∏–µ_–∏—Å—Ç–æ—Ä–∏–π,', '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ_–Ω–∞—Å–µ–∫–æ–º—ã—Ö,', '–°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ_–≥–µ—Ä–±–∞—Ä–∏–µ–≤,', '–ß—Ç–µ–Ω–∏–µ_–ø–æ_–∑–≤—ë–∑–¥–∞–º']
baggages = ['–ï–¥–∞', '–û—Ä—É–∂–∏–µ', '–ú–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã', '–†–µ–º–æ–Ω—Ç–Ω—ã–π_–Ω–∞–±–æ—Ä_—ç–ª–µ–∫—Ç—Ä–∏–∫–∞', '–ù–∞–±–æ—Ä_—Ñ–∏–ª—å—Ç—Ä–æ–≤_–¥–ª—è_–æ—á–∏—Å—Ç–∫–∏_–≤–æ–¥—ã', '–ö–æ–º–ø–∞—Å', '–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω—ã–π_3D‚Äë–ø—Ä–∏–Ω—Ç–µ—Ä', '–ú–∞—Å—Å–∞–∂–Ω–æ–µ_–º–∞—Å–ª–æ', '–ê–ø—Ç–µ—á–∫–∞_—Å_–∂–≥—É—Ç–∞–º–∏_–∏_–∞–Ω—Ç–∏—Å–µ–ø—Ç–∏–∫–∞–º–∏', '–ì–æ–¥–æ–≤–æ–π_–∑–∞–ø–∞—Å_–∑—É–±–Ω–æ–π_–ø–∞—Å—Ç—ã', '–ß–∞—Å—ã_—Å_—Å–µ–∫—É–Ω–¥–æ–º–µ—Ä–æ–º', '–ì—É–±–Ω–∞—è_–≥–∞—Ä–º–æ—à–∫–∞_–∏_–Ω–æ—Ç—ã,', '–õ–∏—á–Ω—ã–π_–¥–Ω–µ–≤–Ω–∏–∫,–ë–ª–æ–∫–Ω–æ—Ç_—Å_—Ç–µ—Ö–Ω–∏–∫–∞–º–∏_–ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤', '–£—á–µ–±–Ω–∏–∫–∏_–ø–æ_–º–∞—Ç–µ–º–∞—Ç–∏–∫–µ(—Å–±–æ—Ä–Ω–∏–∫_–ê–õ–ì–ï–ë–†–´_–ì–ï–û–ú–ï–¢–†–ò–ò_–í–∏–°)', '–ì–∏—Ä–ª—è–Ω–¥—ã_–∏_—Å–≤–µ—á–∏,', '–°–±–æ—Ä–Ω–∏–∫_–º–∏—Ñ–æ–≤_–∏_–ª–µ–≥–µ–Ω–¥,', '–î–Ω–µ–≤–Ω–∏–∫_–º–µ—Ç–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏–π,', '–ü—Ä–µ—Å—Å_–¥–ª—è_—Å—É—à–∫–∏_—Ä–∞—Å—Ç–µ–Ω–∏–π']



# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–æ–ª–µ–π
def generate_roles(num_players):
    roles = []
    cct_count = max(1, num_players // 4)  # –ë–∞–Ω–¥–∏—Ç: 1 –Ω–∞ 4 –∏–≥—Ä–æ–∫–æ–≤
    cct = random.sample(range(num_players), cct_count)
    for i in range(num_players):
        is_cct = i in cct
        role = {
            'profession': random.choice(professions),
            'years': random.choice(years),
            'people': random.choice(people),
            'rost': random.choice(rost),
            'p_y': random.choice(p_y),
            'health': random.choice(healths),
            'hobby': random.choice(hobbies),
            'baggage': random.choice(baggages),
            'is_cct': is_cct
        }
        roles.append(role)
    return roles, cct


# –ö–æ–º–∞–Ω–¥–∞ /start_game ‚Äî –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É –≤ –≥—Ä—É–ø–ø–µ
@bot.message_handler(commands=['start_game'])
def start_game(message):
    chat_id = message.chat.id
    if chat_id in games and games[chat_id]['phase'] != 'waiting':
        bot.send_message(chat_id, "–ò–≥—Ä–∞ —É–∂–µ –∏–¥—ë—Ç!")
        return
    games[chat_id] = {'players': [], 'roles': [], 'phase': 'joining', 'votes': {}, 'cct': []}
    bot.send_message(chat_id,
                     "üéâ –ò–≥—Ä–∞ '–ë—É–Ω–∫–µ—Ä' –Ω–∞—á–∞–ª–∞—Å—å! –ò–≥—Ä–æ–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /join, —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è. –ö–æ–≥–¥–∞ –≤—Å–µ –≥–æ—Ç–æ–≤—ã, –∞–¥–º–∏–Ω –Ω–∞–ø–∏—à–∏—Ç–µ /ready.")


# –ö–æ–º–∞–Ω–¥–∞ /join ‚Äî –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ
@bot.message_handler(commands=['join'])
def join_game(message):
    chat_id = message.chat.id
    user_id = message.from_user.id
    username = message.from_user.username or message.from_user.first_name
    if chat_id not in games or games[chat_id]['phase'] != 'joining':
        bot.send_message(chat_id, "–ò–≥—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞ –∏–ª–∏ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å.")
        return
    if user_id in [p['id'] for p in games[chat_id]['players']]:
        bot.send_message(chat_id, f"{username}, –≤—ã —É–∂–µ –≤ –∏–≥—Ä–µ!")
        return
    games[chat_id]['players'].append({'id': user_id, 'name': username})
    bot.send_message(chat_id, f"{username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è! –ò–≥—Ä–æ–∫–æ–≤: {len(games[chat_id]['players'])}")


# –ö–æ–º–∞–Ω–¥–∞ /ready ‚Äî —Ä–∞–∑–¥–∞—Ç—å —Ä–æ–ª–∏ –∏ –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
@bot.message_handler(commands=['ready'])
def ready_game(message):
    chat_id = message.chat.id
    user_id = message.from_user.id
    if chat_id not in games or games[chat_id]['phase'] != 'joining':
        return
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∞–¥–º–∏–Ω –ª–∏ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ ‚Äî –ø–µ—Ä–≤—ã–π –∏–≥—Ä–æ–∫ –∏–ª–∏ –∫—Ç–æ-—Ç–æ)
    if len(games[chat_id]['players']) < 0:
        bot.send_message(chat_id, "–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 –∏–≥—Ä–æ–∫–∞!")
        return
    games[chat_id]['roles'], games[chat_id]['cct'] = generate_roles(len(games[chat_id]['players']))
    games[chat_id]['phase'] = 'opening'

    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–æ–ª–∏ –∫–∞–∂–¥–æ–º—É –∏–≥—Ä–æ–∫—É –ø—Ä–∏–≤–∞—Ç–Ω–æ
    for i, player in enumerate(games[chat_id]['players']):
        role = games[chat_id]['roles'][i]
        text = f"–í–∞—à–∞ —Ä–æ–ª—å:\n–ü—Ä–æ—Ñ–µ—Å—Å–∏—è: {role['profession']}\n–í–æ–∑—Ä–∞—Å—Ç: {role['years']}\n–ü–æ–ª: {role['people']}\n–†–æ—Å—Ç: {role['rost']}\n–°—Ç–∞–∂_–†–∞–±–æ—Ç—ã: {role['p_y']}\n–ó–¥–æ—Ä–æ–≤—å–µ: {role['health']}\n–•–æ–±–±–∏: {role['hobby']}\n–ë–∞–≥–∞–∂: {role['baggage']}"
        if role['is_cct']:
            cct_names = [games[chat_id]['players'][j]['name'] for j in games[chat_id]['cct'] if j != i]
            text += f"\n–í—ã –ë–∞–Ω–¥–∏—Ç! –î—Ä—É–≥–∏–µ –±–∞–Ω–¥–∏—Ç—ã: {', '.join(cct_names) if cct_names else '–í—ã –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π'}"
        try:
            bot.send_message(player['id'], text)
        except:
            bot.send_message(chat_id, f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–æ–ª—å {player['name']} ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –¥—Ä—É–∑—å—è!")

    bot.send_message(chat_id, "–†–æ–ª–∏ —Ä–æ–∑–¥–∞–Ω—ã! –§–∞–∑–∞: –æ—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞—Ä—Ç. –û–±—Å—É–¥–∏—Ç–µ 5 –º–∏–Ω—É—Ç—ã, –∑–∞—Ç–µ–º /vote.")
    time.sleep(300)  # –ñ–¥–∞—Ç—å 5 –º–∏–Ω—É—Ç—ã (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å scheduler)


# –ö–æ–º–∞–Ω–¥–∞ /vote ‚Äî –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
@bot.message_handler(commands=['vote'])
def vote_phase(message):
    chat_id = message.chat.id
    if chat_id not in games or games[chat_id]['phase'] != 'opening':
        return
    games[chat_id]['phase'] = 'voting'
    games[chat_id]['votes'] = {}
    players = games[chat_id]['players']
    player_list = "\n".join([f"{i + 1}. {p['name']}" for i, p in enumerate(players)])
    bot.send_message(chat_id, f"–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ! –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ (–æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–æ–º–µ—Ä–æ–º):\n{player_list}")


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
@bot.message_handler(func=lambda message: True)
def handle_vote(message):
    chat_id = message.chat.id
    user_id = message.from_user.id
    if chat_id not in games or games[chat_id]['phase'] != 'voting':
        return
    try:
        vote = int(message.text) - 1
        if vote < 0 or vote >= len(games[chat_id]['players']):
            raise ValueError
        games[chat_id]['votes'][user_id] = vote
        bot.send_message(chat_id, f"–ì–æ–ª–æ—Å —É—á—Ç—ë–Ω –æ—Ç {message.from_user.first_name}.")
        # –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏, –ø–æ–¥–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥–∏
        if len(games[chat_id]['votes']) == len(games[chat_id]['players']):
            # –ü–æ–¥—Å—á—ë—Ç –≥–æ–ª–æ—Å–æ–≤
            vote_counts = defaultdict(int)
            for v in games[chat_id]['votes'].values():
                vote_counts[v] += 1
            max_votes = max(vote_counts.values())
            candidates = [k for k, v in vote_counts.items() if v == max_votes]
            exiled = random.choice(candidates) if len(candidates) > 1 else candidates[0]
            exiled_player = games[chat_id]['players'][exiled]
            is_cct = games[chat_id]['roles'][exiled]['is_cct']
            bot.send_message(chat_id, f"–ò–∑–≥–Ω–∞–Ω: {exiled_player['name']} ‚Äî {'–ë–∞–Ω–¥–∏—Ç!' if is_cct else '–ù–µ –ë–∞–Ω–¥–∏—Ç.'}")
            # –£–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞
            del games[chat_id]['players'][exiled]
            del games[chat_id]['roles'][exiled]
            # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–µ—Ü –∏–≥—Ä—ã
            cct_left = sum(1 for r in games[chat_id]['roles'] if r['is_cct'])
            if cct_left == 0:
                bot.send_message(chat_id, "–ü–æ–±–µ–¥–∞ –≤—ã–∂–∏–≤—à–∏—Ö! –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.")
                del games[chat_id]
            elif cct_left >= len(games[chat_id]['players']) - cct_left:
                bot.send_message(chat_id, "–ü–æ–±–µ–¥–∞ –±–∞–Ω–¥–∏—Ç–æ–≤! –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.")
                del games[chat_id]
            else:
                games[chat_id]['phase'] = 'opening'
                bot.send_message(chat_id, "–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥! /vote")
    except ValueError:
        pass


# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.polling(none_stop=True)
